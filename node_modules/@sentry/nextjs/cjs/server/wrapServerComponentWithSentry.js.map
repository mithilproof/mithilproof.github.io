{"version":3,"file":"wrapServerComponentWithSentry.js","sources":["../../../src/server/wrapServerComponentWithSentry.ts"],"sourcesContent":["import {\n  addTracingExtensions,\n  captureException,\n  getCurrentHub,\n  runWithAsyncContext,\n  startTransaction,\n} from '@sentry/core';\nimport { baggageHeaderToDynamicSamplingContext, extractTraceparentData } from '@sentry/utils';\n\nimport { isNotFoundNavigationError, isRedirectNavigationError } from '../common/nextNavigationErrorUtils';\nimport type { ServerComponentContext } from '../common/types';\n\n/**\n * Wraps an `app` directory server component with Sentry error instrumentation.\n */\nexport function wrapServerComponentWithSentry<F extends (...args: any[]) => any>(\n  appDirComponent: F,\n  context: ServerComponentContext,\n): F {\n  addTracingExtensions();\n\n  const { componentRoute, componentType } = context;\n\n  // Even though users may define server components as async functions, for the client bundles\n  // Next.js will turn them into synchronous functions and it will transform any `await`s into instances of the `use`\n  // hook. ðŸ¤¯\n  return new Proxy(appDirComponent, {\n    apply: (originalFunction, thisArg, args) => {\n      return runWithAsyncContext(() => {\n        const hub = getCurrentHub();\n\n        let maybePromiseResult;\n\n        const traceparentData = context.sentryTraceHeader\n          ? extractTraceparentData(context.sentryTraceHeader)\n          : undefined;\n\n        const dynamicSamplingContext = baggageHeaderToDynamicSamplingContext(context.baggageHeader);\n\n        const transaction = startTransaction({\n          op: 'function.nextjs',\n          name: `${componentType} Server Component (${componentRoute})`,\n          status: 'ok',\n          ...traceparentData,\n          metadata: {\n            source: 'component',\n            dynamicSamplingContext: traceparentData && !dynamicSamplingContext ? {} : dynamicSamplingContext,\n          },\n        });\n\n        const currentScope = hub.getScope();\n        if (currentScope) {\n          currentScope.setSpan(transaction);\n        }\n\n        const handleErrorCase = (e: unknown): void => {\n          if (isNotFoundNavigationError(e)) {\n            // We don't want to report \"not-found\"s\n            transaction.setStatus('not_found');\n          } else if (isRedirectNavigationError(e)) {\n            // We don't want to report redirects\n          } else {\n            transaction.setStatus('internal_error');\n            captureException(e);\n          }\n\n          transaction.finish();\n        };\n\n        try {\n          maybePromiseResult = originalFunction.apply(thisArg, args);\n        } catch (e) {\n          handleErrorCase(e);\n          throw e;\n        }\n\n        if (typeof maybePromiseResult === 'object' && maybePromiseResult !== null && 'then' in maybePromiseResult) {\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n          Promise.resolve(maybePromiseResult).then(\n            () => {\n              transaction.finish();\n            },\n            e => {\n              handleErrorCase(e);\n            },\n          );\n\n          // It is very important that we return the original promise here, because Next.js attaches various properties\n          // to that promise and will throw if they are not on the returned value.\n          return maybePromiseResult;\n        } else {\n          transaction.finish();\n          return maybePromiseResult;\n        }\n      });\n    },\n  });\n}\n"],"names":["addTracingExtensions","runWithAsyncContext","getCurrentHub","extractTraceparentData","baggageHeaderToDynamicSamplingContext","startTransaction","isNotFoundNavigationError","isRedirectNavigationError","captureException"],"mappings":"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"}